<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="net.imyeyu.blogapi.mapper.CommentMapper">
	<!-- 新增评论 -->
	<insert id="create" parameterType="net.imyeyu.blogapi.entity.Comment" keyColumn="id" keyProperty="id" useGeneratedKeys="true">
		INSERT INTO comments (
			article_id,
			user_id,
			nick,
			data,
			created_at
		) VALUES (
			#{articleId},
			#{userId},
			#{nick},
			#{data},
			#{createdAt}
		);
	</insert>
	<select id="find" parameterType="long" resultType="net.imyeyu.blogapi.entity.Comment">
		SELECT * FROM comments WHERE id = #{id} AND deleted_at IS NULL
	</select>
	<!-- 获取文章评论（附带子评论） -->
    <select id="findMany" parameterType="map" resultMap="findManyResult">
		SELECT
	        -- 主评论
			c.id,
			c.article_id,
			c.user_id,
			user_has_avatar,
			uc.name AS name,
			c.nick,
			c.data,
			c.created_at,
	        -- 回复
			cr.id AS cr_id,
			cr.comment_id,
			crc.cr_length,
			cr.sender_id,
			cr.receiver_id,
			sender_has_avatar,
			us.name AS sender_name,
			ur.name AS receiver_name,
			cr.sender_nick,
			cr.receiver_nick,
			cr.data AS cr_data,
			cr.created_at AS cr_created_at
		FROM (
	        -- 查询主评论
			SELECT
				c.*,
				usd.has_avatar AS user_has_avatar
			FROM
				comments AS c
			LEFT JOIN
				user_data AS usd
			ON
				usd.user_id = c.user_id
			WHERE
				c.article_id = #{articleId}
				AND c.deleted_at IS NULL
			ORDER BY
				c.created_at DESC
			LIMIT
	            #{offset}, 10
			) AS c
		LEFT JOIN
			users AS uc
		ON
			uc.id = c.user_id
		LEFT JOIN (
	        -- 查询回复
			SELECT
				*
			FROM (
				SELECT
					crt.*,
					urd.has_avatar AS sender_has_avatar,
					ROW_NUMBER() OVER (PARTITION BY comment_id) AS seq
				FROM
					comment_replies AS crt
				LEFT JOIN
					user_data AS urd
				ON
					urd.user_id = crt.sender_id
				WHERE
					crt.deleted_at IS NULL
				) AS cr
			WHERE
				cr.seq &lt; 7
		) AS cr
		ON
			cr.comment_id = c.id
			AND cr.deleted_at IS NULL
		LEFT JOIN
			users AS us
		ON
			us.id = cr.sender_id
		LEFT JOIN
			users AS ur
		ON
			ur.id = cr.receiver_id
		LEFT JOIN(
	        -- 统计回复
			SELECT
				ANY_VALUE(comment_id) AS crc_id,
				COUNT(comment_id) AS cr_length
			FROM
				comment_replies
			GROUP BY
				comment_id
		) AS crc
		ON
			crc.crc_id = c.id
    </select>
	<resultMap id="findManyResult" type="net.imyeyu.blogapi.entity.Comment">
		<id property="id" column="id" />
		<result property="userId" column="user_id" />
		<result property="nick" column="nick" />
		<result property="data" column="data" />
        <result property="repliesLength" column="cr_length" />
		<result property="createdAt" column="created_at" />
		<!-- 发布者 -->
		<association property="user" javaType="net.imyeyu.blogapi.entity.User">
            <id property="id" column="user_id" />
			<result property="name" column="name" />
			<association property="data" javaType="net.imyeyu.blogapi.entity.UserData">
				<result property="hasAvatar" column="user_has_avatar" />
			</association>
        </association>
        <!-- 关联回复 -->
        <collection property="replies" ofType="net.imyeyu.blogapi.entity.CommentReply">
        	<id property="id" column="cr_id" />
        	<result property="commentId" column="comment_id" />
	        <result property="senderId" column="sender_id" />
        	<result property="senderNick" column="sender_nick" />
	        <result property="receiverId" column="receiver_id" />
        	<result property="receiverNick" column="receiver_nick" />
        	<result property="data" column="cr_data" />
			<result property="createdAt" column="cr_created_at" />
        	<!-- 回复者 -->
			<association property="sender" javaType="net.imyeyu.blogapi.entity.User">
	            <id property="id" column="sender_id" />
	            <result property="name" column="sender_name" />
				<association property="data" javaType="net.imyeyu.blogapi.entity.UserData">
					<result property="hasAvatar" column="sender_has_avatar" />
				</association>
	        </association>
	        <!-- 被回复者 -->
			<association property="receiver" javaType="net.imyeyu.blogapi.entity.User">
	            <id property="id" column="receiver_id" />
	            <result property="name" column="receiver_name" />
	        </association>
        </collection>
	</resultMap>
	<!-- 根据用户获取所有评论 -->
	<select id="findAllByUID" resultType="net.imyeyu.blogapi.entity.Comment">
		SELECT * FROM comments WHERE user_id = #{uid} AND deleted_at IS NULL
	</select>
	<!-- 新增子评论 -->
	<insert id="createReply" parameterType="net.imyeyu.blogapi.entity.CommentReply" keyColumn="id" keyProperty="id" useGeneratedKeys="true">
		INSERT INTO comment_replies (
			comment_id,
			sender_id,
			receiver_id,
			sender_nick,
			receiver_nick,
			data,
			created_at
		) VALUES (
			#{commentId},
			#{senderId},
			#{receiverId},
			#{senderNick},
			#{receiverNick},
			#{data},
			#{createdAt}
		);
	</insert>
	<select id="findReply" parameterType="long" resultType="net.imyeyu.blogapi.entity.CommentReply">
		SELECT * FROM comment_replies WHERE id = #{crid} AND deleted_at IS NULL
	</select>
	<!-- 获取文章子评论 -->
    <select id="findManyReplies" parameterType="map" resultMap="findManyRepliesResult">
	    SELECT
			c.id,
			sender_id,
			us.name AS sender_name,
			receiver_id,
			ur.name AS receiver_name,
			sender_nick,
			receiver_nick,
			data,
			c.created_at
		FROM (
			SELECT
				id,
				sender_id,
				receiver_id,
				sender_nick,
				receiver_nick,
				data,
				created_at
			FROM
				comment_replies AS c
			WHERE
				comment_id = #{commentId}
				AND deleted_at IS NULL
			LIMIT #{offset}, 6
		) AS c
		LEFT JOIN
			users AS us
		ON
			us.id = c.sender_id
		LEFT JOIN
			users AS ur
		ON
			ur.id = c.receiver_id
    </select>
	<resultMap id="findManyRepliesResult" type="net.imyeyu.blogapi.entity.CommentReply">
		<id property="id" column="id" />
		<result property="data" column="data" />
		<result property="senderId" column="sender_id" />
		<result property="senderNick" column="sender_nick" />
		<result property="receiverId" column="receiver_id" />
		<result property="receiverNick" column="receiver_nick" />
		<result property="createdAt" column="created_at" />
		<!-- 回复者 -->
		<association property="sender" javaType="net.imyeyu.blogapi.entity.User">
            <id property="id" column="sender_id" />
            <result property="name" column="sender_name" />
        </association>
		<!-- 被回复者 -->
		<association property="receiver" javaType="net.imyeyu.blogapi.entity.User">
            <id property="id" column="receiver_id" />
            <result property="name" column="receiver_name" />
        </association>
	</resultMap>
	<!-- 统计该文章的所有评论和子评论 -->
	<select id="getLength" parameterType="long" resultType="int">
		SELECT
			SUM(r.cc + r.crc)
		FROM (
			SELECT
				COUNT(DISTINCT c.id) AS cc,
				COUNT(cr.comment_id) AS crc
			FROM
				comments AS c
			LEFT JOIN
				comment_replies AS cr
			ON
				cr.comment_id = c.id
			WHERE
				c.article_id = #{aid}
				AND c.deleted_at IS NULL
				AND cr.deleted_at IS NULL
		) AS r
	</select>
	<!-- 删除 -->
	<update id="delete">
		<if test="id != null">
			UPDATE comments
			<set>
				deleted_at = FLOOR(UNIX_TIMESTAMP(NOW(3)) * 1000)
			</set>
			WHERE id = #{id}
		</if>
	</update>
	<update id="deleteByUID">
		<if test="id != null">
			UPDATE comments
			<set>
				deleted_at = FLOOR(UNIX_TIMESTAMP(NOW(3)) * 1000)
			</set>
			WHERE user_id = #{uid}
		</if>
	</update>
	<!-- 删除回复 -->
	<update id="deleteReply">
		<if test="id != null">
			UPDATE comment_replies
			<set>
				deleted_at = FLOOR(UNIX_TIMESTAMP(NOW(3)) * 1000)
			</set>
			WHERE id = #{id}
		</if>
	</update>
	<update id="deleteReplyByUID">
		<if test="id != null">
			UPDATE comment_replies
			<set>
				deleted_at = FLOOR(UNIX_TIMESTAMP(NOW(3)) * 1000)
			</set>
			WHERE
				sender_id = #{uid}
				OR receiver_id = #{uid}
		</if>
	</update>
	<!-- 用户个人空间"我的评论"查询 -->
	<select id="findManyUserComment" resultType="net.imyeyu.blogapi.entity.UserComment">
		SELECT
			r.aid,
			a.title AS aTitle,
			a.type AS aType,

			r.cid,
			r.crid,
			r.data,
			r.created_at AS createdAt
		FROM (
			-- 评论
			SELECT
				c.article_id AS aid,

				c.id AS cid,
				NULL AS crid,
				c.data,
				c.created_at,

				c.user_id AS uid
			FROM
				comments AS c
			WHERE
				c.user_id = 16
			-- 回复
			UNION SELECT
				c.article_id AS aid,

				c.id AS cid,
				cr.id AS crid,
				cr.data,
				c.created_at,

				c.user_id AS uid
			FROM
				comment_replies AS cr
			LEFT JOIN
				comments AS c
			ON
				c.id = cr.comment_id
			WHERE
				cr.sender_id = 16
		) AS r
		-- 关联文章
		LEFT JOIN
			article AS a
		ON
			a.id = aid
		ORDER BY
			r.created_at DESC
		LIMIT
			#{offset}, #{limit}
	</select>
	<!-- 用户个人空间"回复我的"查询 -->
	<select id="findManyUserCommentReplies" resultType="net.imyeyu.blogapi.entity.UserComment">
		SELECT
			c.article_id AS aid,
			a.title AS aTitle,
			a.type AS aType,

			c.id AS cid,
			cr.id AS crid,
			cr.data,
			cr.created_at AS createdAt,

			cr.sender_id AS uid,
			u.name,
			ud.has_avatar AS hasAvatar
		FROM
			comment_replies AS cr
		LEFT JOIN
			comments AS c
		ON
			c.id = cr.comment_id
		-- 关联文章
		LEFT JOIN
			article AS a
		ON
			a.id = c.article_id
		-- 关联用户
		LEFT JOIN
			users AS u
		ON
			u.id = cr.sender_id
		-- 关联用户数据
		LEFT JOIN
			user_data AS ud
		ON
			u.id = ud.user_id
		WHERE
			cr.receiver_id = #{uid}
			AND cr.sender_id != #{uid}
		ORDER BY
			cr.created_at DESC
		LIMIT
			#{offset}, #{limit}
	</select>
</mapper>